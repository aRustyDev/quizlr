#!/bin/bash
set -e

echo "ðŸš€ Running pre-push checks..."

# Check if we're in the right directory
if [ ! -f "Cargo.toml" ]; then
    echo "âŒ Error: Not in project root directory"
    exit 1
fi

# Run full test suite
echo "ðŸ§ª Running full test suite..."
if ! cargo test --workspace --all-features; then
    echo "âŒ Tests failed!"
    exit 1
fi

# Check for security vulnerabilities
echo "ðŸ”’ Checking for security vulnerabilities..."
if command -v cargo-audit > /dev/null 2>&1; then
    if ! cargo audit; then
        echo "âŒ Security vulnerabilities detected!"
        echo "ðŸ’¡ Run 'cargo audit fix' to attempt automatic fixes"
        exit 1
    fi
else
    echo "â„¹ï¸  cargo-audit not installed, install with: cargo install cargo-audit"
fi

# Build documentation
echo "ðŸ“š Building documentation..."
if ! cargo doc --workspace --no-deps --quiet; then
    echo "âŒ Documentation build failed!"
    exit 1
fi

# Verify WASM build
echo "ðŸŒ Verifying WASM build..."
if ! cargo build --package quizlr-core --target wasm32-unknown-unknown --no-default-features --features wasm --quiet; then
    echo "âŒ WASM build failed!"
    exit 1
fi

# Check code coverage (if tarpaulin is installed)
if command -v cargo-tarpaulin > /dev/null 2>&1; then
    echo "ðŸ“Š Checking code coverage..."
    coverage=$(cargo tarpaulin --workspace --print-summary 2>/dev/null | grep "Coverage" | awk '{print $2}' | sed 's/%//')
    if (( $(echo "$coverage < 80" | bc -l) )); then
        echo "âš ï¸  Warning: Code coverage is below 80% (current: $coverage%)"
    fi
else
    echo "â„¹ï¸  cargo-tarpaulin not installed, skipping coverage check"
fi

echo "âœ… All pre-push checks passed!"