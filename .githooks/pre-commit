#!/bin/bash
set -e

echo "üîç Running pre-commit checks..."

# Check if we're in the right directory
if [ ! -f "Cargo.toml" ]; then
    echo "‚ùå Error: Not in project root directory"
    exit 1
fi

# Run formatting check
echo "üìã Checking code formatting..."
if ! cargo fmt --all -- --check > /dev/null 2>&1; then
    echo "‚ùå Code formatting issues detected!"
    echo "üí° Run 'cargo fmt --all' to fix formatting"
    exit 1
fi

# Run clippy
echo "üîß Running clippy..."
if ! cargo clippy --workspace --all-targets --all-features -- -D warnings > /dev/null 2>&1; then
    echo "‚ùå Clippy warnings detected!"
    echo "üí° Run 'cargo clippy --workspace --all-targets --all-features -- -D warnings' to see details"
    exit 1
fi

# Run tests
echo "üß™ Running tests..."
if ! cargo test --workspace --quiet > /dev/null 2>&1; then
    echo "‚ùå Tests failed!"
    echo "üí° Run 'cargo test --workspace' to see details"
    exit 1
fi

# Check for TODO/FIXME comments
echo "üìù Checking for TODO/FIXME comments..."
if grep -r "TODO\|FIXME" --include="*.rs" --include="*.toml" src/ 2>/dev/null; then
    echo "‚ö†Ô∏è  Warning: TODO/FIXME comments found (not blocking)"
fi

# Check dependency licenses
echo "üìú Checking dependency licenses..."
if command -v cargo-license > /dev/null 2>&1; then
    if ! cargo license --json > /dev/null 2>&1; then
        echo "‚ö†Ô∏è  Warning: Could not check licenses (not blocking)"
    fi
else
    echo "‚ÑπÔ∏è  cargo-license not installed, skipping license check"
fi

echo "‚úÖ All pre-commit checks passed!"